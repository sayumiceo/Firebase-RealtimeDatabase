<!DOC
 html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Firebase_version9_RealtimeDB(G'sACADEMYåˆå­¦è€…ç”¨ã‚µãƒ³ãƒ—ãƒ«)</title>
<link rel="stylesheet" href="/css/sample.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Overlock:wght@900&family=Roboto:wght@500&family=Zen+Kaku+Gothic+New&family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">

</head>
<body>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç”»é¢ -->
<div id="user-settings">
    <h1>ADAãƒãƒ£ãƒƒãƒˆ</h1>
    
    <!-- ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ -->
    <div id="icon-selection">
        <p>ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠã—ã¦ã­</p>
        <!-- çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ -->
        <button class="icon-btn">ğŸ˜˜</button>
        <button class="icon-btn">ğŸ¤©</button>
        <button class="icon-btn">ğŸ˜</button>
        <button class="icon-btn">ğŸ¥³</button>
        <button class="icon-btn">ğŸ¤¤</button>
        <button class="icon-btn">ğŸŒ·</button>
        <button class="icon-btn">ğŸ©·</button>
        <button class="icon-btn">ğŸ©µ</button>
        <button class="icon-btn">ğŸ’š</button>
        <button class="icon-btn">ğŸ¦­</button>
        <button class="icon-btn">ğŸ˜»</button>
        <button class="icon-btn">ğŸ¶</button>
    </div>
    
    <!-- èƒŒæ™¯é¸æŠ -->
    <div id="background-selection">
        <p>èƒŒæ™¯ã‚’é¸æŠã—ã¦ã­</p>
        <!-- èƒŒæ™¯è‰² -->
        <button class="bg-btn" style="background-color: rgb(255, 181, 181);"></button>
        <button class="bg-btn" style="background-color: rgb(255, 239, 181);"></button>
        <button class="bg-btn" style="background-color: rgb(202, 239, 202);"></button>
        <button class="bg-btn" style="background-color: rgb(181, 200, 255);"></button>
        <button class="bg-btn" style="background-color: rgb(237, 205, 241);"></button>
        <button class="bg-btn" style="background-color: rgb(248, 206, 231);"></button>
    </div>
    
    <!-- è¨­å®šå®Œäº†ãƒœã‚¿ãƒ³ -->
    <button id="complete-settings">Let's chat</button>
</div>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
<div id="chat-container">
    <div id="messages"></div>

    <!-- é€ä¿¡ãƒœã‚¿ãƒ³ã¨å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="input-container">
        <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <textarea id="message-input" placeholder="Enterã§é€ä¿¡ãƒ»ãƒ»ãƒ»" rows="1"></textarea>
        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
        <button id="send-button"><i class="fa fa-arrow-right"></i></button>
    </div>
    

</div>


<!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** ä»¥ä¸‹Firebase **-->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } 
    from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
  
    // Your web app's Firebase configurationãƒ»ãƒ»ãƒ»è‡ªåˆ†ã ã‘ã®ã‚­ãƒ¼ï¼ï¼ï¼ï¼
    const firebaseConfig = {
    apiKey: "AIzaSyBHv3qHJP57Byx1roxlxsTIqut8woDHfh8",
    authDomain: "chat-3de4b.firebaseapp.com",
    projectId: "chat-3de4b",
    storageBucket: "chat-3de4b.appspot.com",
    messagingSenderId: "236581802750",
    appId: "1:236581802750:web:4caccec8ee62c2a8aa4baf"
    };
    // Your web app's Firebase configurationãƒ»ãƒ»ãƒ»è‡ªåˆ†ã ã‘ã®ã‚­ãƒ¼ï¼ï¼ï¼ï¼

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Elements
    const sendButton = document.getElementById('send-button');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');

// ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    const completeSettingsButton = document.getElementById('complete-settings');
    const userSettings = document.getElementById('user-settings');
    const chatContainer = document.getElementById('chat-container');
    let selectedIcon = '';
    let selectedBackground = '';

    // åˆæœŸçŠ¶æ…‹ã§ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    chatContainer.style.display = 'none';

    // ã‚¢ã‚¤ã‚³ãƒ³ã®é¸æŠã‚’å‡¦ç†
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectedIcon = this.textContent; // é¸æŠã—ãŸçµµæ–‡å­—ã‚’ä¿å­˜
            document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected')); // ä»–ã®ã‚¢ã‚¤ã‚³ãƒ³ã®é¸æŠã‚’è§£é™¤
            this.classList.add('selected'); // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        });
    });

    // èƒŒæ™¯ã®é¸æŠã‚’å‡¦ç†
    document.querySelectorAll('.bg-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectedBackground = this.style.backgroundColor; // é¸æŠã—ãŸèƒŒæ™¯è‰²ã‚’ä¿å­˜
            document.querySelectorAll('.bg-btn').forEach(b => b.classList.remove('selected')); // ä»–ã®èƒŒæ™¯ã®é¸æŠã‚’è§£é™¤
            this.classList.add('selected'); // é¸æŠã•ã‚ŒãŸèƒŒæ™¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

        });
    });

    // å®Œäº†ãƒœã‚¿ãƒ³ã‚’å‡¦ç†
    completeSettingsButton.addEventListener('click', function() {
        if (selectedIcon && selectedBackground) {
            userSettings.style.display = 'none'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç”»é¢ã‚’éè¡¨ç¤º
            chatContainer.style.display = 'flex'; // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤ºï¼ˆflexã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
        } else {
            alert('ã‚¢ã‚¤ã‚³ãƒ³ã¨èƒŒæ™¯ã‚’é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ');
        }
    });
});

let selectedIcon = 'ğŸ˜'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
let selectedBackground = '#ffffff'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èƒŒæ™¯è‰²ã‚’è¨­å®š
const currentUserId = 'current_user';


// Send message function
function sendMessage() {
    const text = messageInput.value.trim();
    if (text) {
        const timestamp = new Date().toISOString(); // UTCã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ISOå½¢å¼ã§ç”Ÿæˆ

        const messageData = {
            text,
            timestamp,
            userId: currentUserId, // é€ä¿¡è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            icon: selectedIcon, // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³
            background: selectedBackground // é¸æŠã•ã‚ŒãŸèƒŒæ™¯è‰²
        };

        // Firebaseã«messageDataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’é€ä¿¡
        push(ref(db, 'messages'), messageData);

        messageInput.value = ''; // Clear the message input after sending
        messageInput.style.height = 'auto'; // Reset the textarea height
    }
}

// Send message to Firebase when send button is clicked
sendButton.addEventListener('click', sendMessage);

// Send message on Enter key press, allow Shift+Enter for new line
messageInput.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    if (!event.isComposing && !event.shiftKey) { // IMEã®å¤‰æ›ä¸­ã§ãªã„ã“ã¨ã€ã¾ãŸã¯Shiftã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
      event.preventDefault(); // æ—¢å®šã®å‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      sendMessage(); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    }
  }
});

// Listen for new messages and append them to the messages div
onChildAdded(ref(db, 'messages'), (snapshot) => {
    const message = snapshot.val();
    const messageDate = new Date(message.timestamp);
    const messageTime = formatAMPM(messageDate);

    // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
    const messageElement = document.createElement('div');
    const textElement = document.createElement('span');
    const timeElement = document.createElement('span');
    textElement.textContent = message.text;
    timeElement.textContent = messageTime;

    if (message.userId === currentUserId) {
        // è‡ªåˆ†ãŒé€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
        messageElement.className = 'message-row sent';
        textElement.className = 'message-text sent';
        // ã‚¢ã‚¤ã‚³ãƒ³ã¯è¡¨ç¤ºã—ãªã„ãŸã‚ã€è¿½åŠ ã—ãªã„
    } else {
        // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
        messageElement.className = 'message-row received';
        textElement.className = 'message-text received';
        const iconElement = document.createElement('span');
        iconElement.className = 'message-icon';
        iconElement.textContent = message.icon; // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’é©ç”¨
        messageElement.appendChild(iconElement); // ã‚¢ã‚¤ã‚³ãƒ³è¦ç´ ã‚’è¿½åŠ 
    }

    messageElement.appendChild(textElement); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’è¿½åŠ 
    messageElement.appendChild(timeElement); // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¦ç´ ã‚’è¿½åŠ 

    messagesDiv.appendChild(messageElement); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’DOMã«è¿½åŠ 
    messagesDiv.scrollTop = messagesDiv.scrollHeight; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
});




// AM/PMå½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function formatAMPM(date) {
    let hours = date.getHours();
    let minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // 0æ™‚é–“ã¯12æ™‚é–“ã¨ã™ã‚‹
    minutes = minutes < 10 ? '0'+minutes : minutes;
    const strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

  </script>

  
</body>
</html>